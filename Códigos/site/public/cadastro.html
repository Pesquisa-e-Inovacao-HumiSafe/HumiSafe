<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro - HumiSafe</title>
  <link rel="stylesheet" href="css/estilo.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="icon" href="imagens/logo.png">
</head>

<body>
  <div class="fundo" id="inicio">
    <div class="header">
      <a href="site_institucional.html#inicio">
      <div class="logo-titulo">
          <img src="imagens/logo.png" alt="">
          <h1>HUMISAFE</h1>
      </div>
      </a>
      <div class="container">
        <ul class="navbar">
          <li>
            <a href="site_institucional.html#inicio">Início</a>
          </li>
          <li>
            <a href="site_institucional.html#sobrenos">Sobre Nós</a>
          </li>
          <li>
            <a href="site_institucional.html#sistema">Sistema</a>
          </li>
          <li>
            <a href="Simulador_financeiro.html">Simulador</a>
          </li>
          <li>
            <a class="agora" href="cadastro.html">Cadastrar</a>
          </li>
          <li>
            <a class="button" href="login.html">Entrar <div class="id_img_login"></div></a>
          </li>
        </ul>
      </div>

    </div>
  </div>

  <div class="cadastro">
    <div class="card card-cadastro">
      <h2>Cadastro da Empresa</h2>
      <div class="formulario">
        <div class="campo">
          <span>Razão Social:</span>
          <input id="Razao_input" type="text" placeholder="Digite o nome da empresa" value="HumiSafe LTDA">
        </div>
        <div class="campo">
          <span>Nome Fantasia:</span>
          <input id="nome_input" type="text" placeholder="Digite o nome da empresa" value="HumiSafe">
        </div>
        <div class="campo">
          <span>CNPJ:</span>
          <input id="cnpj_input" type="text" placeholder="Digite o CNPJ" value="19.829.184/0001-19" maxlength="18" oninput="formatarCNPJ()">
        </div>
        <div class="campo">
          <span>E-mail:</span>
          <input id="email_input" type="email" placeholder="Ex: exemplo@email.com" value="HumiSafe@email.com">
        </div>
        <div class="campo">
          <span>Telefone:</span>
          <input id="telefone_input" type="text" placeholder="Digite o telefone" maxlength="15"
            oninput="formatarTelefone()" value="(11) 96937-2801">
        </div>
        <div class="campo">
          <span>Senha:</span>
          <input id="senha_input" type="password" placeholder="Crie uma senha" value="123">
        </div>
        <div class="campo">
          <span>Confirmar Senha:</span>
          <input id="confirmar_senha_input" type="password" placeholder="Confirme a senha" value="123">
        </div>
        <br>
        <button onclick="Cadastrar()" class="botao">Cadastrar Empresa</button>
      </div>
    </div>
  </div>
  <div id="div_mensagem"></div>
<div id="mensagem_erro"></div>
</body>
</html>
<script>
  
  function formatarCNPJ() {
    
    var cnpj = cnpj_input.value;
    var cnpj_fixo = cnpj_input.value;
    
    var cnpjNumerico = "";
    for (var i = 0; i < cnpj.length; i++) {
      var caractere = cnpj[i];
      if (caractere >= "0" && caractere <= "9") {
        cnpjNumerico += caractere;
      }
    }

    var formatado = "";
    for (var i = 0; i < cnpjNumerico.length && i < 14; i++) {
      if (i == 2 || i == 5) {
        formatado += ".";
      } else if (i == 8) {
        formatado += "/";
      } else if (i == 12) {
        formatado += "-";
      }
      formatado += cnpjNumerico[i];
    }
    
    cnpj_input.value = formatado;
  }
  
  function formatarTelefone() {
    
    var telefone = telefone_input.value;
    
    
    var numeros = "";
    for (var i = 0; i < telefone.length; i++) {
      var caractere = telefone[i];
      if (caractere >= "0" && caractere <= "9") {
        numeros += caractere;
      }
    }
    
    if (numeros.length > 11) {
      numeros = numeros.slice(0, 11);
    }
    
    var formatado = "";
    for (var i = 0; i < numeros.length; i++) {
      if (i == 0) {
        formatado += "(";
      } else if (i == 2) {
        formatado += ") ";
      } else if (i == 7) {
        formatado += "-";
      }
      formatado += numeros[i];
    }
    
    telefone_input.value = formatado;
  }

  // Array para armazenar empresas cadastradas para validação de código de ativação 
  // let listaEmpresasCadastradas = [];
  
  function Cadastrar() {
    // aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var razaoVar = Razao_input.value;
    var nomeVar = nome_input.value;
    var cnpjVar = cnpj_input.value;
    var emailVar = email_input.value;
    var telefoneVar = telefone_input.value;
    var senhaVar = senha_input.value;
    var confirmarSenhaVar = confirmar_senha_input.value;

    // Verificando se há algum campo em branco
    if (
      razaoVar == "" ||
      nomeVar == "" ||
      cnpjVar == "" ||
      emailVar == "" ||
      telefoneVar == "" ||
      senhaVar == "" ||
      confirmarSenhaVar == ""
    ) {
      mensagem_erro.innerHTML = "(por favor preencha todos campos.)";
      finalizarAguardar();
      return false;
    } 
    // else {
    //   setInterval(sumirMensagem, 5000);
    // }

    // Verificando se o código de ativação é de alguma empresa cadastrada
    // for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
    //   if (listaEmpresasCadastradas[i].codigo_ativacao == codigoVar) {
    //     idEmpresaVincular = listaEmpresasCadastradas[i].id
    //     console.log("Código de ativação válido.");
    //     break;
    //   } else {
    //     mensagem_erro.innerHTML = "(Mensagem de erro para código inválido)";
    //     finalizarAguardar();
    //   }
    // }
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        razaoServer: razaoVar,
        nomeServer: nomeVar,
        cnpjServer: cnpjVar,
        emailServer: emailVar,
        telefoneServer: telefoneVar,
        senhaServer: senhaVar
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
        
          mensagem_erro.innerHTML =
            "Cadastro realizado com sucesso! Redirecionando para tela de cadastro de endereço...";

          setTimeout(() => {
            window.location = "cadastrarEndereco.html";
          }, "2000");

          limparFormulario();
          finalizarAguardar();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        // finalizarAguardar();
      });

    return false;
  }

  // Listando empresas cadastradas 
  // function listar() {
  //   fetch("/empresas/listar", {
  //     method: "GET",
  //   })
  //     .then(function (resposta) {
  //       resposta.json().then((empresas) => {
  //         listaEmpresasCadastradas = empresas;

  //         empresas.forEach((empresa) => {
  //           listaEmpresasCadastradas.push(empresa);
  //           console.log("listaEmpresasCadastradas")
  //           console.log(listaEmpresasCadastradas[0].codigo_ativacao)
  //         });
  //       });
  //     })
  //     .catch(function (resposta) {
  //       console.log(`#ERRO: ${resposta}`);
  //     });
  // }

  // function sumirMensagem() {
  //   cardErro.style.display = "none";
  // }
</script>